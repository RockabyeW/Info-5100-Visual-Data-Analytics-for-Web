<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="submap" content="width=device-width, initial-scale=1.0">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <title>Project 2 Info 3300</title>
</head>

<body>
    <h1>US Map and Subway restaurant distributions</h1>

    <div id="container">

        <div id="cont1">
            <button id="toHawaii">view Hawaii</button>
            <button id="toAlaska">view Alaska</button>
            <button id="toUS">back to (continental) US</button>
        </div>

        <div id="cont2">
            <svg id="subway" height="800" width="1000" style="background: #fff; margin-top:50px">
            </svg>
        </div>

    </div>

    <style>
        h1 {
            font-weight: 600;
            line-height: 38px;
            letter-spacing: .1rem;
            text-transform: lowercase;
            text-decoration: none;
            color: #555;
        }

        button {
            display: inline-block;
            height: 38px;
            padding: 0 30px;
            color: #555;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            line-height: 38px;
            letter-spacing: .1rem;
            text-transform: lowercase;
            text-decoration: none;
            white-space: nowrap;
            background-color: transparent;
            border-radius: 4px;
            border: 1px solid #bbb;
            cursor: pointer;
            box-sizing: border-box;
        }

        button:focus {
            background-image: linear-gradient(to right,
            #b3e2cd,#fdcdac,#cbd5e8,#f4cae4,#e6f5c9,#fff2ae,#f1e2cc,#cccccc
            );
            animation: slidebg 2s linear infinite;
            color: #555;
        }

        #container {
            display: flex;
            flex-direction: column;
        }

        #cont1 {
            margin-top: 10px;

        }

        .state {
            fill: white;
        }

        .outline {
            fill: none;
            stroke: black;
            stroke-width: 1px;
        }


        .tooltip {
            pointer-events: none;
        }
    </style>

    <script>

        // Regular map + Zoom

        const requestData = async function () {

            const us = await d3.json("us.json");

            let filteredStates = ['2', '02', '15', '60', '66', '69', '72', '74', '78'];
            // let filteredStates = [];
            us.objects.states.geometries = us.objects.states.geometries.filter(d => {
                return filteredStates.indexOf(d.id.toString().padStart(2, '0')) === -1;
            });

            var states = topojson.feature(us, us.objects.states);
            var statesMesh = topojson.mesh(us, us.objects.states);
            var counties = topojson.feature(us, us.objects.counties);
            var countiesMesh = topojson.mesh(us, us.objects.counties);

            let subsvg = d3.select("#subway");
            let subwidth = subsvg.attr("width");
            let subheight = subsvg.attr("height");
            let submapWidth = subwidth;
            let submapHeight = subheight;

            let projection = d3.geoMercator().fitSize([subwidth, subheight], states);
            // var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
            var path = d3.geoPath().projection(projection);
            var submap = subsvg.append("g");
            var subway = await d3.csv("subway_locations_in_us.csv", d3.autoType);


            submap.append("path")
                .attr("class", "graticule")
                .attr("d", path(d3.geoGraticule10()))
                .attr("fill", "none");

            submap.selectAll(".state").data(states.features)
                .enter()
                .append("path")
                .attr("class", "state")
                .attr("d", path)
                .attr("stroke-width", 3)
                .attr("stroke", "none")
                .attr("fill", "none")
                .on("mouseover", mouseEntersState)
                .on("mouseout", mouseLeaveState);

            submap.selectAll(".county").data(counties.features)
                .enter()
                .append("path")
                .attr("class", "county")
                .attr("d", path)
                .attr("stroke-width", 1.2)
                .attr("stroke", "lightblue")
                .attr("fill", "none");

            let countyoutline = submap.append("path")
                .datum(countiesMesh)
                .attr("class", "county-outline")
                .attr("d", path)
                .attr("fill", "none");

            let stateoutline = submap.append("path")
                .datum(statesMesh)
                .attr("class", "state-outline")
                .attr("d", path)
                .attr("fill", "none");

            subway.forEach((d, i) => {
                d.position = projection([d.longitude, d.latitude]);
            });

            submap.selectAll("circle").data(subway)
                .join("circle")
                .attr("r", 2)
                .attr("fill", "forestgreen")
                .attr("opacity", 0.4)
                .attr("cx", d => d.position[0])
                .attr("cy", d => d.position[1]);

  
            let tooltipWidth = 120;
            let tooltipHeight = 40;

            let momesh = submap.append("path")
                .attr("class", "mouseover outline")
                .style("stroke", "black")
                .style("stroke-width", 3)
                .attr("d", "");

            let tooltip = submap.append("g")
                .attr("class", "tooltip")
                .attr("visibility", "hidden");

            tooltip.append("rect")
                .attr("fill", "black")
                .attr("opacity", 0.9)
                .attr("x", -tooltipWidth / 2.0)
                .attr("y", 0)
                .attr("width", tooltipWidth)
                .attr("height", tooltipHeight)
            let txt = tooltip.append("text")
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "hanging")
                .attr("x", 0)
                .attr("y", 2);

            let txt2 = tooltip.append("text")
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "hanging")
                .attr("x", 0)
                .attr("y", 22);

            // count store frequency by state 

            arr = [];
            subway.forEach((d, i) => {
                arr.push(d.state);
            });

            var occurrences = {};
            for (var i = 0, j = arr.length; i < j; i++) {
                occurrences[arr[i]] = (occurrences[arr[i]] || 0) + 1;
            }

            // console.log((occurrences));

            function mouseEntersState() {
                // Make tooltip visible
                tooltip.style("visibility", "visible");

                // Find the state SVG element and add stroke
                let state = d3.select(this);

                // // Original version before adding the bonus mesh after class
                state.attr("stroke", "black")
                    .attr("stroke-width", 3);

                // Using .datum() to recover the data for the state element (because we used a .join() to make it)...
                // ... get the name of the state and count
                let stateID = state.datum().id;
                let stateNames = ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming'];
                console.log(stateNames[stateID+1]);
                txt.text(stateNames[stateID-1]);
                txt2.text("todo count");

                // You can use the geoPath() generator to do all sorts of helpful things 
                // let [xPos, yPos] = path.centroid( state.datum() );  // Get the pixel "center" of the state

                let bounds = path.bounds(state.datum());   // Get the pixel boundaries of the state
                // In both cases here, the geoPath() is parsing the fancy topoJSON data to figure out pixels using the projection

                // Place it at the bottom of the state, centered
                let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
                let yPos = bounds[1][1] - 15;

                // Transform the <g> group so that everything moves together easily
                tooltip.attr("transform", `translate(${xPos},${yPos})`);

                var mo = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
                //  Then apply it to your special mesh that's on top of everything else (added earlier in this file)
                momesh.datum(mo).attr("d", path)
            }

            function mouseLeaveState() {
                tooltip.style("visibility", "hidden");

                let state = d3.select(this);
                // Reset old style mouseover stroke
                state.attr("stroke", "none")
                    .attr("stroke-width", 0);

                // Here we are hiding the mouseover mesh we added as bonus content
                // momesh.attr("d", "");
            }

            let stateIdCounts = {} // stateID => count #
            let stateIdNames = {} // stateID => name of state
            subway.forEach(row => {
                stateIdCounts[row.state] = Number(row.total);
                stateIdNames[row.state] = row.state;
            });


            function plotZoomed({ transform }) {
                console.log(transform);

                submap.attr("transform", transform.toString());

                submap.select("stateoutline")
                    .style("stroke-width", 1 / transform.k);
            }
            
            // function ZoomM({transform}) {   
            //     viewport.attr("transform", transform.toString() );
            //     viewport.select(".zippath")
            //                 .style("stroke-width", 1 / transform.k);
            // }


            var plotZoom = d3.zoom()
                .scaleExtent([1, 10])
                .on("zoom", plotZoomed);

            subsvg.call(plotZoom);



            d3.select("#toAlaska")
                .on("click", function () {
                    submap.attr("transform", "translate(1011, 686)");

                })

            d3.select("#toUS")
                .on("click", function () {
                    submap.attr("transform", "translate(-1, 12)");

                })

            d3.select("#toHawaii")
                .on("click", function () {
                    submap.attr("transform", "translate(1138, -544)");

                })


        }
        requestData();


    </script>

</body>

</html>
<style>
    circle {
        pointer-events: none;
    }
</style>